<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¿åŠ¨è®¡æ—¶å™¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            color: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 900px;
            width: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            text-align: center;
            position: relative;
        }
        
        h1 {
            margin-bottom: 20px;
            font-size: 2.5rem;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }
        
        .current-time {
            font-size: 1.5rem;
            margin-bottom: 10px;
            color: #fdbb2d;
        }
        
        .timer-status-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            position: relative;
            width: 100%;
        }
        
        .timer-status {
            font-size: 1.2rem;
            color: #4CAF50;
            font-weight: bold;
            transition: all 0.3s;
            flex: 1;
            text-align: center;
        }
        
        .timer-status.pulsing {
            animation: pulse 1.5s infinite;
        }
        
        .progress-indicator {
            background-color: rgba(253, 187, 45, 0.8);
            color: #333;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
            min-width: 50px;
            flex: 0;
        }
        
        .next-phase-indicator {
            font-size: 1.2rem;
            color: #aaa;
            font-weight: bold;
            flex: 1;
            text-align: center;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .phase-info {
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            display: flex;
            flex-direction: row;
            align-items: center;
            position: relative;
            height: 400px;
            overflow: hidden;
        }
        
        .phase-left {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            position: relative;
            overflow: hidden;
        }
        
        .phase-right {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
        }
        
        .phase-carousel {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        
        .phase-carousel-track {
            display: flex;
            transition: transform 0.5s ease;
            width: 100%;
            height: 100%;
        }
        
        .phase-carousel-item {
            flex: 0 0 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 20px;
            transition: all 0.5s ease;
            opacity: 0.3;
            transform: scale(0.8);
        }
        
        .phase-carousel-item.prev {
            opacity: 0.6;
            transform: scale(0.9);
        }
        
        .phase-carousel-item.active {
            opacity: 1;
            transform: scale(1);
        }
        
        .phase-carousel-item.next {
            opacity: 0.6;
            transform: scale(0.9);
        }
        
        .phase-name {
            font-size: 2.2rem;
            color: #fdbb2d;
            margin-bottom: 10px;
        }
        
        .phase-description {
            font-size: 1rem;
            color: #aaa;
            margin-bottom: 15px;
        }
        
        .phase-timer {
            font-size: 9rem;
            font-weight: bold;
            color: #fff;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
            line-height: 1;
            margin-bottom: 10px;
        }
        
        .phase-timer-label {
            font-size: 1.2rem;
            color: #aaa;
        }
        
        .completion-message {
            font-size: 3rem;
            font-weight: bold;
            color: #4CAF50;
            text-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
            line-height: 1.2;
            margin-bottom: 20px;
            animation: celebration 2s infinite;
        }
        
        @keyframes celebration {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .carousel-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #fdbb2d;
            font-size: 1.8rem;
            cursor: pointer;
            z-index: 10;
            transition: all 0.3s;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }
        
        .carousel-prev {
            left: 5px;
        }
        
        .carousel-next {
            right: 5px;
        }
        
        .carousel-nav-vertical {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            background: none;
            border: none;
            color: #fdbb2d;
            font-size: 1.8rem;
            cursor: pointer;
            z-index: 10;
            transition: all 0.3s;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }
        
        .carousel-nav-vertical:hover {
            background-color: rgba(253, 187, 45, 0.2);
        }
        
        .carousel-prev-vertical {
            top: 5px;
        }
        
        .carousel-next-vertical {
            bottom: 5px;
        }
        
        .total-timer-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 20px 0;
        }
        
        .start-time, .end-time {
            font-size: 1.2rem;
            color: #aaa;
            flex: 1;
        }
        
        .start-time {
            text-align: left;
        }
        
        .end-time {
            text-align: right;
        }
        
        .total-timer {
            font-size: 2.5rem;
            font-weight: bold;
            color: #4CAF50;
            flex: 2;
            text-align: center;
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 30px 0;
            flex-wrap: wrap;
        }
        
        .main-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        button {
            padding: 12px 25px;
            font-size: 1.2rem;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            min-width: 120px;
        }
        
        #startBtn {
            background-color: #4CAF50;
            color: white;
        }
        
        #pauseBtn {
            background-color: #FFC107;
            color: black;
        }
        
        #resetBtn {
            background-color: #F44336;
            color: white;
        }
        
        button:active {
            transform: translateY(1px);
        }
        
        button:disabled {
            background-color: #cccccc;
            color: #666666;
            cursor: not-allowed;
            transform: none;
        }
        
        /* è®¾ç½®æŒ‰é’®æ ·å¼ */
        .settings-buttons {
            position: absolute;
            top: 20px;
            left: 20px;
            display: flex;
            gap: 10px;
        }
        
        .settings-btn {
            padding: 5px;
            background-color: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 20px;
            color: white;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
            width: 25px;
            height: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .settings-btn:hover {
            background-color: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }
        
        .top-right-buttons {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
        }
        
        /* æ¨¡æ€æ¡†æ ·å¼ - ä¼˜åŒ–ç‰ˆ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 100;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: linear-gradient(145deg, #2c2c2c, #1f1f1f);
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            text-align: center;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            border: 1px solid #444;
        }
        
        .modal-header {
            background: linear-gradient(145deg, #3a3a3a, #2a2a2a);
            padding: 20px 30px;
            border-radius: 15px 15px 0 0;
            position: sticky;
            top: 0;
            z-index: 10;
            border-bottom: 1px solid #555;
        }
        
        .modal h2 {
            margin-bottom: 20px;
            color: #fdbb2d;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
        }
        
        .modal-body {
            padding: 0 30px 30px;
        }
        
        .modal label {
            display: block;
            margin-bottom: 10px;
            font-size: 1.2rem;
            text-align: left;
            color: #e0e0e0;
        }
        
        .modal input, .modal select {
            width: 100%;
            padding: 10px;
            font-size: 1.2rem;
            margin-bottom: 20px;
            border-radius: 5px;
            border: 1px solid #555;
            background-color: #444;
            color: white;
            transition: all 0.3s;
        }
        
        .modal input:focus, .modal select:focus {
            outline: none;
            border-color: #fdbb2d;
            box-shadow: 0 0 5px rgba(253, 187, 45, 0.5);
        }
        
        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
        }
        
        .modal button {
            min-width: 100px;
            background: linear-gradient(145deg, #fdbb2d, #e6a720);
            color: #333;
            border: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .modal button:hover {
            background: linear-gradient(145deg, #ffc845, #f0b52a);
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
        }
        
        /* å‡†å¤‡å€’è®¡æ—¶æ ·å¼ */
        .countdown-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s, visibility 0.5s;
        }
        
        .countdown-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .countdown-number {
            font-size: 20rem;
            color: #fdbb2d;
            text-shadow: 0 0 20px rgba(253, 187, 45, 0.8);
            font-weight: bold;
            animation: pulse 1s infinite;
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100%;
            text-align: center;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        /* é˜¶æ®µç¼–è¾‘é¡¹æ ·å¼ - ä¼˜åŒ–ç‰ˆ */
        .phase-edit-item {
            margin-bottom: 15px;
            padding: 15px;
            background: linear-gradient(145deg, #3a3a3a, #2a2a2a);
            border-radius: 10px;
            text-align: left;
            border: 1px solid #444;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .phase-edit-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }
        
        .phase-edit-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: #fdbb2d;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .phase-duration-display {
            color: #aaa;
            font-weight: normal;
            font-size: 0.9rem;
        }
        
        .toggle-btn {
            background: none;
            border: none;
            color: #fdbb2d;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px;
            transition: transform 0.3s;
        }
        
        .toggle-btn:hover {
            transform: scale(1.1);
        }
        
        .phase-edit-content {
            margin-top: 15px;
            display: none;
        }
        
        .phase-edit-content.show {
            display: block;
        }
        
        .phase-edit-content label {
            display: block;
            margin-bottom: 5px;
            font-size: 1rem;
            color: #e0e0e0;
        }
        
        .phase-edit-content input {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border-radius: 5px;
            border: 1px solid #555;
            background-color: #444;
            color: white;
            transition: all 0.3s;
        }
        
        .phase-edit-content input:focus {
            outline: none;
            border-color: #fdbb2d;
            box-shadow: 0 0 5px rgba(253, 187, 45, 0.5);
        }
        
        .delete-phase-btn {
            background: linear-gradient(145deg, #F44336, #d32f2f);
            margin-top: 10px;
            padding: 8px 15px;
            min-width: auto;
            color: white;
        }
        
        /* è¯­éŸ³è®¾ç½®è¡¨æ ¼æ ·å¼ - ä¼˜åŒ–ç‰ˆ */
        .tts-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            background: linear-gradient(145deg, #3a3a3a, #2a2a2a);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .tts-table th, .tts-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #444;
        }
        
        .tts-table th {
            background: linear-gradient(145deg, #4a4a4a, #3a3a3a);
            color: #fdbb2d;
            font-weight: bold;
        }
        
        .tts-table tr:last-child td {
            border-bottom: none;
        }
        
        .tts-table input, .tts-table select {
            width: 100%;
            padding: 8px;
            background-color: #444;
            border: 1px solid #555;
            color: white;
            border-radius: 4px;
            transition: all 0.3s;
        }
        
        .tts-table input:focus, .tts-table select:focus {
            outline: none;
            border-color: #fdbb2d;
            box-shadow: 0 0 5px rgba(253, 187, 45, 0.5);
        }
        
        .tts-table button {
            padding: 6px 12px;
            min-width: auto;
            font-size: 0.9rem;
            background: linear-gradient(145deg, #F44336, #d32f2f);
            color: white;
        }
        
        .add-tts-btn {
            background: linear-gradient(145deg, #4CAF50, #388E3C);
            margin-bottom: 10px;
            color: white;
        }
        
        .tts-voice-controls {
            display: none;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            background: linear-gradient(145deg, #3a3a3a, #2a2a2a);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #444;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .tts-voice-controls.show {
            display: flex;
        }
        
        .tts-voice-control {
            flex: 1;
            min-width: 150px;
        }
        
        .tts-voice-control label {
            display: block;
            margin-bottom: 5px;
            font-size: 0.9rem;
            color: #e0e0e0;
        }
        
        .tts-test-btn {
            background: linear-gradient(145deg, #2196F3, #1976D2);
            margin-bottom: 15px;
            color: white;
        }
        
        .toggle-voice-settings-btn {
            background: linear-gradient(145deg, #9C27B0, #7B1FA2);
            margin-bottom: 15px;
            color: white;
        }
        
        /* ç§»åŠ¨ç«¯ä¼˜åŒ– */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
                border-radius: 15px;
            }
            
            h1 {
                font-size: 2rem;
            }
            .startTimeLeft {
                display: none;
            }
            .endTimeRight {
                display: none;
            }
            .timer-status-container {
                flex-direction: row;
                gap: 10px;
            }
            
            .progress-indicator {
                margin-top: 5px;
            }
            
            .next-phase-indicator {
                margin-top: 5px;
                text-align: center;
            }
            
            .phase-info {
                flex-direction: column;
                height: auto;
            }
            
            .phase-left, .phase-right {
                width: 100%;
                height: auto;
            }
            
            .phase-name {
                font-size: 1.8rem;
            }
            
            .phase-timer {
                font-size: 8.5rem;
            }
            
            .completion-message {
                font-size: 2.5rem;
            }
            
            .total-timer-container {
                flex-direction: column;
                gap: 5px;
            }
            
            .total-timer {
                font-size: 2rem;
                order: -1;
            }
            
            .start-time, .end-time {
                font-size: 1rem;
                width: 100%;
                text-align: center;
            }
            
            /* ç§»åŠ¨ç«¯æ—¶é—´æ˜¾ç¤ºåœ¨ä¸€è¡Œ */
            .time-row {
                display: flex;
                justify-content: space-between;
                width: 100%;
                margin-top: 5px;
            }
            
            button {
                padding: 10px 15px;
                font-size: 1rem;
                min-width: 100px;
            }
            
            .settings-btn {
                min-width: 50px;
            }
            
            .controls {
                flex-direction: column;
                align-items: center;
            }
            
            .main-controls {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            /* ç§»åŠ¨ç«¯å€’è®¡æ—¶å­—ä½“å¤§å°è°ƒæ•´ */
            .countdown-number {
                font-size: 15rem;
            }
            
            /* ç§»åŠ¨ç«¯è®¾ç½®æŒ‰é’®ä½ç½®è°ƒæ•´ - ç¡®ä¿å·¦ä¸Šè§’å’Œå³ä¸Šè§’ */
            .settings-buttons {
                position: absolute;
                top: 15px;
                left: 15px;
            }
            
            .top-right-buttons {
                position: absolute;
                top: 15px;
                right: 15px;
            }
            
            /* ç§»åŠ¨ç«¯æ¨¡æ€æ¡†è°ƒæ•´ */
            .modal-content {
                padding: 0;
            }
            
            .modal-header {
                padding: 15px 20px;
            }
            
            .modal-body {
                padding: 0 20px 20px;
            }
            
            .modal-buttons {
                flex-wrap: wrap;
            }
            
            .tts-voice-controls {
                flex-direction: column;
            }
            
            /* ç§»åŠ¨ç«¯è½®ç›˜å¯¼èˆªæŒ‰é’®éšè—å‚ç›´æ–¹å‘ï¼Œæ˜¾ç¤ºæ°´å¹³æ–¹å‘ */
            .carousel-nav-vertical {
                display: none;
            }
            
            .carousel-nav {
                display: block;
            }
        }
        
        @media (min-width: 769px) {
            /* æ¡Œé¢ç«¯è½®ç›˜å¯¼èˆªæŒ‰é’®éšè—æ°´å¹³æ–¹å‘ï¼Œæ˜¾ç¤ºå‚ç›´æ–¹å‘ */
            .carousel-nav {
                display: none;
            }
            
            .carousel-nav-vertical {
                display: flex;
            }
            
            .phase-carousel-track {
                flex-direction: column;
                height: 100%;
            }
            
            .phase-carousel-item {
                flex: 0 0 100%;
                height: 100%;
            }
            
            /* å®½å±æ—¶ï¼Œå¼€å§‹æ—¶é—´å’Œç»“æŸæ—¶é—´åˆ†åˆ«åœ¨æ€»æ—¶é—´çš„å·¦è¾¹å’Œå³è¾¹ */
            .total-timer-container {
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            
            .start-time {
                text-align: left;
                flex: 1;
            }
            
            .end-time {
                text-align: right;
                flex: 1;
            }
            
            .total-timer {
                flex: 2;
                text-align: center;
            }
            
            /* ç§»é™¤ç§»åŠ¨ç«¯çš„æ—¶é—´è¡Œæ ·å¼ */
            .time-row {
                display: none;
            }
        }
        
        @media (max-width: 480px) {
            .phase-timer {
                font-size: 5rem;
            }
            .startTimeLeft {
                display: none;
            }
            .endTimeRight {
                display: none;
            }
            
            .completion-message {
                font-size: 2rem;
            }
            
            .countdown-number {
                font-size: 12rem;
            }
            
            .phase-name {
                font-size: 1.5rem;
            }
            
            .phase-description {
                font-size: 0.9rem;
            }
            
            .total-timer {
                font-size: 1.8rem;
            }
            
            .controls {
                gap: 10px;
            }
            
            .main-controls {
                gap: 10px;
            }
            
            button {
                padding: 10px 12px;
                min-width: 90px;
                font-size: 0.9rem;
            }
            
            .settings-btn {
                min-width: 10px;
            }
            
            .start-time, .end-time {
                font-size: 0.9rem;
            }
            
            .tts-table {
                font-size: 0.8rem;
            }
            
            .tts-table th, .tts-table td {
                padding: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="settings-buttons">
            <button class="settings-btn" id="editPhasesBtn" title="ç¼–è¾‘é˜¶æ®µ">âœï¸</button>
        </div>
        
        <div class="top-right-buttons">
            <button class="settings-btn" id="ttsSettingsBtn" title="è¯­éŸ³è®¾ç½®">ğŸ”Š</button>
        </div>
        
        <div class="current-time" id="currentTime">å½“å‰æ—¶é—´: --:--:--</div>
        
        <div class="timer-status-container">
            <div class="timer-status" id="timerStatus">æœªå¼€å§‹</div>
            <div class="progress-indicator" id="progressIndicator">1/7</div>
            <div class="next-phase-indicator" id="nextPhaseIndicator">â†’ä¼‘æ¯æ—¶é—´</div>
        </div>
        
        <div class="phase-info">
            <div class="phase-left">
                <div class="phase-carousel">
                    <button class="carousel-nav carousel-prev" id="carouselPrev">â—€</button>
                    <button class="carousel-nav carousel-next" id="carouselNext">â–¶</button>
                    
                    <button class="carousel-nav-vertical carousel-prev-vertical" id="carouselPrevVertical">â–²</button>
                    <button class="carousel-nav-vertical carousel-next-vertical" id="carouselNextVertical">â–¼</button>
                    
                    <div class="phase-carousel-track" id="phaseCarouselTrack">
                        <!-- é˜¶æ®µå†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
            </div>
            
            <div class="phase-right">
                <div class="phase-timer" id="phaseTimer">00:00</div>
                <div class="phase-timer-label">é˜¶æ®µå€’è®¡æ—¶</div>
            </div>
        </div>
        
        <div class="total-timer-container">
            <div class="start-time startTimeLeft" id="startTime">å¼€å§‹æ—¶é—´: --:--:--</div>
            <div class="total-timer" id="totalTimer">æ€»æ—¶é—´: 00:00:00</div>
            <div class="end-time endTimeRight" id="endTime">ç»“æŸæ—¶é—´: --:--:--</div>
            <!-- ç§»åŠ¨ç«¯ä½¿ç”¨çš„æ—¶é—´è¡Œ -->
            <div class="time-row">
                <div class="start-time" id="startTimeMobile">å¼€å§‹æ—¶é—´: --:--:--</div>
                <div class="end-time" id="endTimeMobile">ç»“æŸæ—¶é—´: --:--:--</div>
            </div>
        </div>
        
        <div class="controls">
            <div class="main-controls">
                <button id="startBtn">å¼€å§‹</button>
                <button id="pauseBtn" disabled>æš‚åœ</button>
                <button id="resetBtn" disabled>é‡ç½®</button>
            </div>
        </div>
        
    </div>

    <!-- å‡†å¤‡å€’è®¡æ—¶è¦†ç›–å±‚ -->
    <div class="countdown-overlay" id="countdownOverlay">
        <div class="countdown-number" id="countdownNumber">3</div>
    </div>

    <!-- ç¼–è¾‘é˜¶æ®µæ¨¡æ€æ¡† -->
    <div class="modal" id="editPhasesModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ç¼–è¾‘è®­ç»ƒé˜¶æ®µ</h2>
                <div class="modal-buttons">
                    <button id="addPhaseBtn">æ·»åŠ é˜¶æ®µ</button>
                    <button id="savePhasesBtn">ä¿å­˜</button>
                    <button id="cancelPhasesEditBtn">å–æ¶ˆ</button>
                </div>
            </div>
            <div class="modal-body">
                <div id="phasesEditContainer">
                    <!-- é˜¶æ®µç¼–è¾‘å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
        </div>
    </div>

    <!-- è¯­éŸ³è®¾ç½®æ¨¡æ€æ¡† -->
    <div class="modal" id="ttsSettingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>è¯­éŸ³æç¤ºè®¾ç½®</h2>
                <div class="modal-buttons">
                    <button id="toggleVoiceSettingsBtn" class="toggle-voice-settings-btn">æ˜¾ç¤ºè¯­éŸ³è®¾ç½®</button>
                    <button id="addTtsBtn">æ·»åŠ è¯­éŸ³æç¤º</button>
                    <button id="saveTtsBtn">ä¿å­˜</button>
                    <button id="cancelTtsBtn">å–æ¶ˆ</button>
                </div>
            </div>
            <div class="modal-body">
                <div class="tts-voice-controls" id="ttsVoiceControls">
                    <div class="tts-voice-control">
                        <label for="ttsVoice">éŸ³è‰²:</label>
                        <select id="ttsVoice">
                            <option value="">é»˜è®¤éŸ³è‰²</option>
                        </select>
                    </div>
                    <div class="tts-voice-control">
                        <label for="ttsPitch">éŸ³è°ƒ (0.5-2):</label>
                        <input type="range" id="ttsPitch" min="0.5" max="2" step="0.1" value="1">
                        <span id="ttsPitchValue">1.0</span>
                    </div>
                    <div class="tts-voice-control">
                        <label for="ttsRate">è¯­é€Ÿ (0.5-2):</label>
                        <input type="range" id="ttsRate" min="0.5" max="2" step="0.1" value="1">
                        <span id="ttsRateValue">1.0</span>
                    </div>
                    <div class="tts-voice-control">
                        <button id="ttsTestBtn" class="tts-test-btn">æµ‹è¯•è¯­éŸ³</button>
                    </div>
                </div>
                
                <p>è®¾ç½®åœ¨ä¸åŒé˜¶æ®µå’Œæ—¶é—´ç‚¹æ’­æ”¾çš„è¯­éŸ³æç¤º</p>
                
                <table class="tts-table" id="ttsTable">
                    <thead>
                        <tr>
                            <th>é˜¶æ®µ</th>
                            <th>æ—¶é—´ç‚¹(ç§’)</th>
                            <th>è¯­éŸ³å†…å®¹</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="ttsTableBody">
                        <!-- è¯­éŸ³æç¤ºå†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // å®šä¹‰è®­ç»ƒé˜¶æ®µ - å°†è®­ç»ƒå®Œæˆä½œä¸ºæœ€åä¸€ä¸ªé˜¶æ®µ
        const phases = [
            { name: "çƒ­èº«é˜¶æ®µ", duration: 15 * 60, description: "å‡†å¤‡æ´»åŠ¨ï¼Œæé«˜å¿ƒç‡" },
            { name: "ä¼‘æ¯æ—¶é—´", duration: 2 * 60, description: "çŸ­æš‚ä¼‘æ¯" },
            { name: "æ‹³å‡»è®­ç»ƒ", duration: 30 * 60, description: "é«˜å¼ºåº¦æ‹³å‡»ç»ƒä¹ " },
            { name: "ä¼‘æ¯æ—¶é—´", duration: 3 * 60, description: "æ¢å¤ä½“åŠ›" },
            { name: "åŠ›é‡è®­ç»ƒ", duration: 30 * 60, description: "å¢å¼ºè‚Œè‚‰åŠ›é‡" },
            { name: "ä¼‘æ¯æ—¶é—´", duration: 2 * 60, description: "çŸ­æš‚ä¼‘æ¯" },
            { name: "æ”¾æ¾æ‹‰ä¼¸", duration: 10 * 60, description: "ç¼“è§£è‚Œè‚‰ç´§å¼ " },
            { name: "è®­ç»ƒå®Œæˆ", duration: 0, description: "æ­å–œå®Œæˆè®­ç»ƒï¼å¤ªæ£’å•¦ï¼", isCompletion: true }
        ];

        // å®šä¹‰æ–‡æœ¬è½¬è¯­éŸ³è®¾ç½®
        let ttsSettings = [
	// çƒ­èº«é˜¶æ®µæé†’
            { phaseId: 0, timePoint: 10, text: "çƒ­èº«é˜¶æ®µå³å°†ç»“æŸï¼Œè¯·å‡†å¤‡ä¼‘æ¯" },
            { phaseId: 0, timePoint: 899, text: "ä½¿ç”¨å¼€åˆè·³æˆ–è€…è·³ç»³æ¥è¿›è¡Œåˆå§‹çƒ­èº«" },
            { phaseId: 0, timePoint: 720, text: "è¿›è¡ŒåŠ¨æ€æ‹‰ä¼¸ã€é«˜æŠ¬è…¿ã€åè¸¢è…¿ç­‰åŠ¨ä½œ" },
            { phaseId: 0, timePoint: 180, text: "æœ€åä¸‰åˆ†é’Ÿå¿«é€Ÿç¢æ­¥ã€é«˜æŠ¬è…¿è¿›è¡Œç¥ç»æ¿€æ´»" },
	// ä¼‘æ¯é˜¶æ®µæé†’
            { phaseId: 1, timePoint: 10, text: "ä¼‘æ¯é˜¶æ®µå³å°†ç»“æŸï¼Œè¯·å‡†å¤‡æ‹³å‡»è®­ç»ƒ" },
            { phaseId: 1, timePoint: 119, text: "å¿«é€Ÿè¡¥æ°´ï¼Œè°ƒæ•´æ‰‹ç»·å¸¦ï¼Œå¿ƒç†å‡†å¤‡è¿›å…¥æ‹³å‡»çŠ¶æ€ã€‚" },
            { phaseId: 3, timePoint: 10, text: "ä¼‘æ¯é˜¶æ®µå³å°†ç»“æŸï¼Œè¯·å‡†å¤‡åŠ›é‡è®­ç»ƒ" },
            { phaseId: 3, timePoint: 179, text: "å……åˆ†è¡¥æ°´ï¼Œæ“¦æ±—ï¼Œæ·±å‘¼å¸è®©å¿ƒç‡ç¨ä½œå›è½ï¼Œä¸ºåŠ›é‡è®­ç»ƒåšå‡†å¤‡ã€‚" },
            { phaseId: 5, timePoint: 10, text: "ä¼‘æ¯é˜¶æ®µå³å°†ç»“æŸï¼Œè¯·å‡†å¤‡æ”¾æ¾æ‹‰ä¼¸" },
            { phaseId: 5, timePoint: 119, text: "æ‹¿å–ç­‹è†œæªã€é“ºå«å­ï¼Œå‡†å¤‡è¿›è¡Œæœ€åæ”¾æ¾ã€‚" },

	//æ‹³å‡»é˜¶æ®µå†…æé†’
            { phaseId: 2, timePoint: 10, text: "æ‹³å‡»è®­ç»ƒé˜¶æ®µå³å°†ç»“æŸï¼Œè¯·å‡†å¤‡ä¼‘æ¯" },
            { phaseId: 2, timePoint: 1799, text: "å…ˆè¿›è¡Œä¸€åˆ†é’Ÿé™æ­¢åŸºæœ¬å§¿åŠ¿" },
            { phaseId: 2, timePoint: 1740, text: "è¿›è¡Œå‰åå·¦å³æ»‘æ­¥å„ä¸€åˆ†é’Ÿ" },
            { phaseId: 2, timePoint: 1650, text: "æ³¨æ„ï¼Œè´¨é‡å¤§äºæ•°é‡ï¼Œä¿æŒåŠ¨ä½œæ ‡å‡†" },
            { phaseId: 2, timePoint: 1500, text: "è¿›è¡ŒæŠ€æœ¯æ‰“ç£¨ï¼Œä»Šå¤©æ˜¯æ‘†æ‹³ï¼Œå‰åæ‰‹å‡»å¤´å„äº”åæ¬¡" },
            { phaseId: 2, timePoint: 1300, text: "æ³¨æ„ï¼Œè´¨é‡å¤§äºæ•°é‡ï¼Œä¿æŒåŠ¨ä½œæ ‡å‡†" },
            { phaseId: 2, timePoint: 600, text: "æ‹³å‡»è®­ç»ƒé˜¶æ®µè¿˜å‰©ååˆ†é’Ÿ" },
            { phaseId: 2, timePoint: 300, text: "ç»“åˆæ­¥æ³•ï¼Œç§»åŠ¨å‡ºæ‹³" },
            { phaseId: 2, timePoint: 150, text: "æ³¨æ„ï¼Œè´¨é‡å¤§äºæ•°é‡ï¼Œä¿æŒåŠ¨ä½œæ ‡å‡†" },

	// åŠ›é‡è®­ç»ƒé˜¶æ®µå†…æé†’
            { phaseId: 4, timePoint: 10, text: "åŠ›é‡è®­ç»ƒé˜¶æ®µå³å°†ç»“æŸï¼Œè¯·å‡†å¤‡ä¼‘æ¯" },
            { phaseId: 4, timePoint: 1799, text: "å‡†å¤‡ä¸€ç»„åŠ›ç«­å‡»æŒä¿¯å§æ’‘" },
            { phaseId: 4, timePoint: 1770, text: "å‡†å¤‡äºŒç»„åŠ›ç«­å‡»æ‹³ä¿¯å§æ’‘" },
            { phaseId: 4, timePoint: 1500, text: "å‡†å¤‡ä¸‰ç»„è‡ªé‡æ·±è¹²20æ¬¡" },
            { phaseId: 4, timePoint: 1200, text: "å‡†å¤‡è…¹è‚Œæ ¸å¿ƒè®­ç»ƒ" },
            { phaseId: 4, timePoint: 600, text: "åŠ›é‡è®­ç»ƒé˜¶æ®µè¿˜å‰©10åˆ†é’Ÿ" },

	// æ”¾æ¾æ‹‰ä¼¸é˜¶æ®µå†…æé†’
            { phaseId: 6, timePoint: 10, text: "æ”¾æ¾æ‹‰ä¼¸é˜¶æ®µå³å°†ç»“æŸï¼Œè®­ç»ƒå³å°†å®Œæˆ" },
            { phaseId: 6, timePoint: 599, text: "ç­‹è†œæªé‡ç‚¹æ”¾æ¾è‚©ã€æ‰‹è‡‚ã€èƒ¸ã€èƒŒã€è…¿ï¼Œæ²¿ç€è‚Œè‚‰çš„ç”Ÿé•¿èµ°å‘ç¼“æ…¢ç§»åŠ¨ï¼Œä¸è¦æ¥å›èƒ¡ä¹±éœ‡åŠ¨ã€‚" },
            { phaseId: 6, timePoint: 540, text: "æ–½åŠ ç¨³å®šã€é€‚åº¦çš„å‹åŠ›ï¼Œä»¥æ„Ÿè§‰åˆ°è‚Œè‚‰æ·±å¤„æœ‰éœ‡åŠ¨æ„Ÿä¸ºå®œã€‚" },
            { phaseId: 6, timePoint: 480, text: "ä»¥æ¯ç§’2-4å˜ç±³çš„é€Ÿåº¦ç¼“æ…¢ç§»åŠ¨ï¼Œåœ¨ç‰¹åˆ«é…¸ç—›çš„â€œæ¿€ç—›ç‚¹â€ä¸Šå¯ä»¥åœç•™10-30ç§’ã€‚" },
            { phaseId: 6, timePoint: 420, text: "å°½é‡è®©æŒ‰æ‘©å¤´ä¸è‚Œè‚‰è¡¨é¢ä¿æŒ90åº¦å‚ç›´ï¼Œä»¥ç¡®ä¿åŠ›é‡èƒ½æœ‰æ•ˆä¼ å¯¼è‡³æ·±å±‚ã€‚" },
            { phaseId: 6, timePoint: 300, text: "æ”¾æ¾æ‹‰ä¼¸é˜¶æ®µè¿˜å‰©5åˆ†é’Ÿ" },
            { phaseId: 6, timePoint: 280, text: "é™æ€æ‹‰ä¼¸ï¼š èƒ¸ã€è‚©ã€æ‰‹è‡‚ã€èƒŒéƒ¨ã€å¤§è…¿ã€è‡€ã€å°è…¿ã€é«‹" },
            { phaseId: 6, timePoint: 230, text: "ç¼“æ…¢åœ°è¿›å…¥æ‹‰ä¼¸å§¿åŠ¿ï¼Œé¿å…ç”¨çˆ†å‘åŠ›å¼¹éœ‡ã€‚" },
            { phaseId: 6, timePoint: 205, text: "æ‹‰ä¼¸åˆ°æ„Ÿè§‰è‚Œè‚‰æœ‰è½»å¾®çš„ã€èˆ’é€‚çš„ç‰µæ‹‰æ„Ÿå³å¯ï¼Œç»ä¸æ˜¯å‰§ç—›ã€‚" },
            { phaseId: 6, timePoint: 255, text: "åœ¨æ¯ä¸ªå§¿åŠ¿ä¿æŒ20-30ç§’ï¼ŒæœŸé—´è¿›è¡Œæ·±é•¿è€Œç¼“æ…¢çš„å‘¼å¸ï¼Œç”¨å‘¼æ°”æ¥å¸®åŠ©èº«ä½“æ›´æ·±åœ°æ”¾æ¾ã€‚" },
            { phaseId: 6, timePoint: 180, text: "ä¸¤ä¾§èº«ä½“éƒ½è¦æ‹‰ä¼¸ï¼Œæ—¶é—´ä¿æŒä¸€è‡´ã€‚" },

        ];

        // è·å–DOMå…ƒç´ 
        const currentTimeElement = document.getElementById('currentTime');
        const timerStatusElement = document.getElementById('timerStatus');
        const progressIndicatorElement = document.getElementById('progressIndicator');
        const nextPhaseIndicatorElement = document.getElementById('nextPhaseIndicator');
        const totalTimerElement = document.getElementById('totalTimer');
        const phaseTimerElement = document.getElementById('phaseTimer');
        const startBtn = document.getElementById('startBtn');
        const pauseBtn = document.getElementById('pauseBtn');
        const resetBtn = document.getElementById('resetBtn');
        const startTimeElement = document.getElementById('startTime');
        const endTimeElement = document.getElementById('endTime');
        const startTimeMobileElement = document.getElementById('startTimeMobile');
        const endTimeMobileElement = document.getElementById('endTimeMobile');
        
        // è½®ç›˜å…ƒç´ 
        const phaseCarouselTrack = document.getElementById('phaseCarouselTrack');
        const carouselPrev = document.getElementById('carouselPrev');
        const carouselNext = document.getElementById('carouselNext');
        const carouselPrevVertical = document.getElementById('carouselPrevVertical');
        const carouselNextVertical = document.getElementById('carouselNextVertical');
        
        // è®¾ç½®æŒ‰é’®å…ƒç´ 
        const editPhasesBtn = document.getElementById('editPhasesBtn');
        const ttsSettingsBtn = document.getElementById('ttsSettingsBtn');
        
        // æ¨¡æ€æ¡†ç›¸å…³å…ƒç´ 
        const editPhasesModal = document.getElementById('editPhasesModal');
        const ttsSettingsModal = document.getElementById('ttsSettingsModal');
        const phasesEditContainer = document.getElementById('phasesEditContainer');
        const ttsTableBody = document.getElementById('ttsTableBody');
        
        // æ¨¡æ€æ¡†æŒ‰é’®
        const addPhaseBtn = document.getElementById('addPhaseBtn');
        const savePhasesBtn = document.getElementById('savePhasesBtn');
        const cancelPhasesEditBtn = document.getElementById('cancelPhasesEditBtn');
        const addTtsBtn = document.getElementById('addTtsBtn');
        const saveTtsBtn = document.getElementById('saveTtsBtn');
        const cancelTtsBtn = document.getElementById('cancelTtsBtn');
        
        // è¯­éŸ³è®¾ç½®å…ƒç´ 
        const ttsVoiceControls = document.getElementById('ttsVoiceControls');
        const toggleVoiceSettingsBtn = document.getElementById('toggleVoiceSettingsBtn');
        const ttsVoice = document.getElementById('ttsVoice');
        const ttsPitch = document.getElementById('ttsPitch');
        const ttsPitchValue = document.getElementById('ttsPitchValue');
        const ttsRate = document.getElementById('ttsRate');
        const ttsRateValue = document.getElementById('ttsRateValue');
        const ttsTestBtn = document.getElementById('ttsTestBtn');
        
        // æ–°å¢ï¼šå‡†å¤‡å€’è®¡æ—¶å…ƒç´ 
        const countdownOverlay = document.getElementById('countdownOverlay');
        const countdownNumber = document.getElementById('countdownNumber');

        // åˆå§‹åŒ–å˜é‡
        let currentPhase = 0;
        let totalSeconds = 0;
        let phaseSeconds = phases[0].duration;
        let isRunning = false;
        let isPaused = false;
        let timerInterval;
        let currentTimeInterval;
        let startTimestamp = null;
        let endTimestamp = null;
        let ttsVoiceSettings = {
            voice: null,
            pitch: 1,
            rate: 1
        };
        
        // æ–°å¢ï¼šéŸ³é¢‘ä¸Šä¸‹æ–‡å’ŒéŸ³é¢‘ç¼“å­˜
        let audioContext;
        let tickSoundBuffer;
        let warningSoundBuffer;
        let celebrationSoundBuffer;
        let audioInitialized = false;

        // åˆå§‹åŒ–é˜¶æ®µè½®ç›˜æ˜¾ç¤º
        function initializePhaseCarousel() {
            phaseCarouselTrack.innerHTML = '';
            phases.forEach((phase, index) => {
                const phaseItem = document.createElement('div');
                phaseItem.className = 'phase-carousel-item';
                phaseItem.id = `phase-carousel-${index}`;
                
                const phaseName = document.createElement('div');
                phaseName.className = 'phase-name';
                phaseName.textContent = phase.name;
                
                const phaseDescription = document.createElement('div');
                phaseDescription.className = 'phase-description';
                phaseDescription.textContent = phase.description;
                
                phaseItem.appendChild(phaseName);
                phaseItem.appendChild(phaseDescription);
                
                phaseCarouselTrack.appendChild(phaseItem);
            });
            
            // è®¾ç½®å½“å‰é˜¶æ®µä¸ºæ¿€æ´»çŠ¶æ€
            updateCarouselActivePhase();
            updateNextPhaseIndicator();
        }

        // æ›´æ–°è½®ç›˜å½“å‰æ¿€æ´»é˜¶æ®µ
        function updateCarouselActivePhase() {
            // ç§»é™¤æ‰€æœ‰æ¿€æ´»çŠ¶æ€
            document.querySelectorAll('.phase-carousel-item').forEach(item => {
                item.classList.remove('active', 'prev', 'next');
            });
            
            // è®¾ç½®å½“å‰é˜¶æ®µä¸ºæ¿€æ´»çŠ¶æ€
            const currentPhaseItem = document.getElementById(`phase-carousel-${currentPhase}`);
            if (currentPhaseItem) {
                currentPhaseItem.classList.add('active');
            }
            
            // å¦‚æœä¸æ˜¯å®Œæˆé˜¶æ®µï¼Œè®¾ç½®å‰ä¸€ä¸ªå’Œåä¸€ä¸ªé˜¶æ®µ
            if (!phases[currentPhase].isCompletion) {
                // è®¾ç½®å‰ä¸€ä¸ªé˜¶æ®µ
                const prevPhase = currentPhase > 0 ? currentPhase - 1 : phases.length - 1;
                const prevPhaseItem = document.getElementById(`phase-carousel-${prevPhase}`);
                if (prevPhaseItem) {
                    prevPhaseItem.classList.add('prev');
                }
                
                // è®¾ç½®åä¸€ä¸ªé˜¶æ®µ
                const nextPhase = currentPhase < phases.length - 1 ? currentPhase + 1 : 0;
                const nextPhaseItem = document.getElementById(`phase-carousel-${nextPhase}`);
                if (nextPhaseItem) {
                    nextPhaseItem.classList.add('next');
                }
            }
            
            // æ›´æ–°è½®ç›˜ä½ç½®
            updateCarouselPosition();
            
            // æ›´æ–°è¿›åº¦æŒ‡ç¤ºå™¨
            updateProgressIndicator();
            
            // æ›´æ–°ä¸‹ä¸€é˜¶æ®µæŒ‡ç¤ºå™¨
            updateNextPhaseIndicator();
            
            // æ›´æ–°å¯¼èˆªæŒ‰é’®æ˜¾ç¤ºçŠ¶æ€
            updateNavigationButtons();
        }

        // æ›´æ–°å¯¼èˆªæŒ‰é’®æ˜¾ç¤ºçŠ¶æ€
        function updateNavigationButtons() {
            const isCompletionPhase = phases[currentPhase].isCompletion;
            
            // å¦‚æœæ˜¯å®Œæˆé˜¶æ®µï¼Œéšè—æ‰€æœ‰å¯¼èˆªæŒ‰é’®
            if (isCompletionPhase) {
                carouselPrev.style.display = 'none';
                carouselNext.style.display = 'none';
                carouselPrevVertical.style.display = 'none';
                carouselNextVertical.style.display = 'none';
            } else {
                // æ ¹æ®å±å¹•å®½åº¦å†³å®šæ˜¾ç¤ºå“ªç§å¯¼èˆªæŒ‰é’®
                const isMobile = window.innerWidth <= 768;
                if (isMobile) {
                    carouselPrev.style.display = 'flex';
                    carouselNext.style.display = 'flex';
                    carouselPrevVertical.style.display = 'none';
                    carouselNextVertical.style.display = 'none';
                } else {
                    carouselPrev.style.display = 'none';
                    carouselNext.style.display = 'none';
                    carouselPrevVertical.style.display = 'flex';
                    carouselNextVertical.style.display = 'flex';
                }
            }
        }

        // æ›´æ–°ä¸‹ä¸€é˜¶æ®µæŒ‡ç¤ºå™¨
        function updateNextPhaseIndicator() {
            // ä¿®å¤ï¼šå¦‚æœæ˜¯è®­ç»ƒå®Œæˆé˜¶æ®µï¼Œä¸æ˜¾ç¤ºç®­å¤´
            if (phases[currentPhase].isCompletion) {
                nextPhaseIndicatorElement.textContent = "å·²å®Œæˆ";
            } else {
                const nextPhaseIndex = currentPhase < phases.length - 1 ? currentPhase + 1 : 0;
                nextPhaseIndicatorElement.textContent = `â†’${phases[nextPhaseIndex].name}`;
            }
        }

        // æ›´æ–°è¿›åº¦æŒ‡ç¤ºå™¨
        function updateProgressIndicator() {
            // è®­ç»ƒå®Œæˆé˜¶æ®µä¸è®¡å…¥è¿›åº¦
            const totalPhasesForProgress = phases.length - 1;
            
            if (phases[currentPhase].isCompletion) {
                progressIndicatorElement.textContent = `${totalPhasesForProgress}/${totalPhasesForProgress}`;
            } else {
                progressIndicatorElement.textContent = `${currentPhase + 1}/${totalPhasesForProgress}`;
            }
        }

        // æ›´æ–°è½®ç›˜ä½ç½®
        function updateCarouselPosition() {
            const track = document.getElementById('phaseCarouselTrack');
            const isMobile = window.innerWidth <= 768;
            
            if (isMobile) {
                // ç§»åŠ¨ç«¯ï¼šæ°´å¹³æ»šåŠ¨
                track.style.transform = `translateX(-${currentPhase * 100}%)`;
            } else {
                // æ¡Œé¢ç«¯ï¼šå‚ç›´æ»šåŠ¨
                track.style.transform = `translateY(-${currentPhase * 100}%)`;
            }
        }

        // æ›´æ–°å½“å‰æ—¶é—´æ˜¾ç¤º
        function updateCurrentTime() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            currentTimeElement.textContent = `å½“å‰æ—¶é—´: ${hours}:${minutes}:${seconds}`;
        }

        // æ›´æ–°è®¡æ—¶å™¨çŠ¶æ€æ˜¾ç¤º
        function updateTimerStatus() {
            if (!isRunning && !isPaused) {
                timerStatusElement.textContent = "æœªå¼€å§‹";
                timerStatusElement.style.color = "#FFC107";
                timerStatusElement.classList.add('pulsing');
            } else if (isPaused) {
                timerStatusElement.textContent = "å·²æš‚åœ";
                timerStatusElement.style.color = "#FF9800";
                timerStatusElement.classList.add('pulsing');
            } else {
                timerStatusElement.textContent = "è¿›è¡Œä¸­";
                timerStatusElement.style.color = "#4CAF50";
                timerStatusElement.classList.remove('pulsing');
            }
        }

        // æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤º
        function formatTime(totalSeconds) {
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            
            if (hours > 0) {
                return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            } else {
                return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            }
        }

        // æ›´æ–°é˜¶æ®µæ˜¾ç¤º
        function updatePhaseDisplay() {
            // æ›´æ–°æ€»æ—¶é—´
            totalTimerElement.textContent = `æ€»æ—¶é—´: ${formatTime(totalSeconds)}`;
            
            // æ›´æ–°å½“å‰é˜¶æ®µè®¡æ—¶å™¨
            if (phases[currentPhase].isCompletion) {
                // å®Œæˆé˜¶æ®µæ˜¾ç¤ºæ­£è®¡æ—¶
                phaseTimerElement.textContent = formatTime(phaseSeconds);
                phaseTimerElement.style.color = "#4CAF50";
            } else {
                // å…¶ä»–é˜¶æ®µæ˜¾ç¤ºå€’è®¡æ—¶
                phaseTimerElement.textContent = formatTime(phaseSeconds);
                phaseTimerElement.style.color = "#fff";
            }
            
            // æ›´æ–°è½®ç›˜æ¿€æ´»çŠ¶æ€
            updateCarouselActivePhase();
        }

        // åˆå§‹åŒ–éŸ³é¢‘ç³»ç»Ÿ
        function initializeAudio() {
            if (audioInitialized) return;
            
            try {
                // åˆ›å»ºéŸ³é¢‘ä¸Šä¸‹æ–‡
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // åˆ›å»ºè½»å¿«çš„æ»´ç­”å£°
                const tickLength = 0.05 * audioContext.sampleRate;
                tickSoundBuffer = audioContext.createBuffer(1, tickLength, audioContext.sampleRate);
                const tickData = tickSoundBuffer.getChannelData(0);
                for (let i = 0; i < tickLength; i++) {
                    // ä½¿ç”¨æ›´é«˜çš„é¢‘ç‡å’Œæ›´çŸ­çš„æŒç»­æ—¶é—´
                    tickData[i] = Math.sin(1200 * 2 * Math.PI * i / audioContext.sampleRate) * 
                                 Math.exp(-i / (0.03 * audioContext.sampleRate));
                }
                
                // åˆ›å»ºè­¦å‘Šå£°ï¼ˆç”¨äºå€’è®¡æ—¶å’Œé˜¶æ®µåˆ‡æ¢ï¼‰
                const warningLength = 0.2 * audioContext.sampleRate;
                warningSoundBuffer = audioContext.createBuffer(1, warningLength, audioContext.sampleRate);
                const warningData = warningSoundBuffer.getChannelData(0);
                for (let i = 0; i < warningLength; i++) {
                    // ä½¿ç”¨æ›´é«˜çš„é¢‘ç‡å’Œæ›´çŸ­çš„æŒç»­æ—¶é—´
                    warningData[i] = Math.sin(1500 * 2 * Math.PI * i / audioContext.sampleRate) * 
                                    Math.exp(-i / (0.1 * audioContext.sampleRate));
                }
                
                // åˆ›å»ºåº†ç¥éŸ³æ•ˆï¼ˆæ›´æ¬¢å¿«æ„‰æ‚¦çš„éŸ³æ•ˆï¼‰
                const celebrationLength = 4.5 * audioContext.sampleRate;
                celebrationSoundBuffer = audioContext.createBuffer(1, celebrationLength, audioContext.sampleRate);
                const celebrationData = celebrationSoundBuffer.getChannelData(0);
                
                // åˆ›å»ºä¸Šå‡çš„éŸ³é˜¶æ•ˆæœ - æ›´æ„‰æ‚¦çš„éŸ³ç¬¦åºåˆ—
                const notes = [523.25, 587.33, 659.25, 698.46, 783.99, 880.00, 987.77, 1046.50, 1174.66, 1318.51]; // C5åˆ°E6
                const noteDuration = celebrationLength / notes.length / audioContext.sampleRate;
                
                for (let i = 0; i < celebrationLength; i++) {
                    const t = i / audioContext.sampleRate;
                    const noteIndex = Math.floor(t / noteDuration);
                    
                    if (noteIndex < notes.length) {
                        const freq = notes[noteIndex];
                        const noteProgress = (t - noteIndex * noteDuration) / noteDuration;
                        
                        // æ·»åŠ ä¸€äº›è°æ³¢å’ŒåŒ…ç»œ - æ›´æ„‰æ‚¦çš„æ³¢å½¢
                        celebrationData[i] = 0.4 * (
                            Math.sin(2 * Math.PI * freq * t) * 
                            (1 - Math.exp(-noteProgress/0.1)) * Math.exp(-noteProgress/0.7) +
                            0.2 * Math.sin(2 * Math.PI * freq * 2 * t) * 
                            (1 - Math.exp(-noteProgress/0.1)) * Math.exp(-noteProgress/0.7) +
                            0.1 * Math.sin(2 * Math.PI * freq * 3 * t) * 
                            (1 - Math.exp(-noteProgress/0.1)) * Math.exp(-noteProgress/0.7)
                        );
                    } else {
                        celebrationData[i] = 0;
                    }
                }
                
                audioInitialized = true;
            } catch (e) {
                console.error("éŸ³é¢‘åˆå§‹åŒ–å¤±è´¥:", e);
            }
        }

        // æ’­æ”¾éŸ³é¢‘
        function playSound(buffer) {
            if (!audioInitialized || !audioContext) {
                initializeAudio();
                return;
            }
            
            try {
                // æ£€æŸ¥éŸ³é¢‘ä¸Šä¸‹æ–‡çŠ¶æ€ï¼Œå¦‚æœæ˜¯æŒ‚èµ·çŠ¶æ€åˆ™æ¢å¤
                if (audioContext.state === 'suspended') {
                    audioContext.resume();
                }
                
                const source = audioContext.createBufferSource();
                source.buffer = buffer;
                source.connect(audioContext.destination);
                source.start();
            } catch (e) {
                console.error("æ’­æ”¾éŸ³é¢‘å¤±è´¥:", e);
            }
        }

        // æ’­æ”¾æ»´ç­”å£°
        function playTickSound() {
            if (tickSoundBuffer) {
                playSound(tickSoundBuffer);
            }
        }

        // æ’­æ”¾è­¦å‘Šå£°
        function playWarningSound() {
            if (warningSoundBuffer) {
                playSound(warningSoundBuffer);
            }
        }

        // æ’­æ”¾åº†ç¥éŸ³æ•ˆ
        function playCelebrationSound() {
            if (celebrationSoundBuffer) {
                playSound(celebrationSoundBuffer);
            }
        }

        // æ–‡æœ¬è½¬è¯­éŸ³
        function speakText(text) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'zh-CN';
                utterance.rate = ttsVoiceSettings.rate;
                utterance.pitch = ttsVoiceSettings.pitch;
                utterance.volume = 1.0;
                
                // è®¾ç½®è¯­éŸ³
                if (ttsVoiceSettings.voice) {
                    utterance.voice = ttsVoiceSettings.voice;
                }
                
                // åœæ­¢ä»»ä½•æ­£åœ¨è¿›è¡Œçš„è¯­éŸ³
                window.speechSynthesis.cancel();
                
                // æ’­æ”¾æ–°è¯­éŸ³
                window.speechSynthesis.speak(utterance);
            } else {
                console.log("æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒæ–‡æœ¬è½¬è¯­éŸ³åŠŸèƒ½");
            }
        }

        // æ£€æŸ¥å¹¶æ’­æ”¾è¯­éŸ³æç¤º
        function checkAndPlayTts() {
            // å®Œæˆé˜¶æ®µä¸æ’­æ”¾è¯­éŸ³æç¤º
            if (phases[currentPhase].isCompletion) return;
            
            // æŸ¥æ‰¾å½“å‰é˜¶æ®µçš„è¯­éŸ³æç¤º
            const currentPhaseTts = ttsSettings.filter(tts => tts.phaseId === currentPhase);
            
            // æ£€æŸ¥æ˜¯å¦æœ‰åŒ¹é…çš„è¯­éŸ³æç¤º
            currentPhaseTts.forEach(tts => {
                if (phaseSeconds === tts.timePoint) {
                    speakText(tts.text);
                }
            });
        }

        // åˆ‡æ¢åˆ°æŒ‡å®šé˜¶æ®µ
        function switchToPhase(phaseIndex) {
            if (phaseIndex < 0 || phaseIndex >= phases.length) return;
            
            // å¦‚æœæ˜¯å®Œæˆé˜¶æ®µï¼Œä¸å…è®¸åˆ‡æ¢
            if (phases[phaseIndex].isCompletion && !phases[currentPhase].isCompletion) {
                return;
            }
            
            currentPhase = phaseIndex;
            phaseSeconds = phases[currentPhase].duration;
            updatePhaseDisplay();
        }

        // åˆ‡æ¢åˆ°ä¸Šä¸€é˜¶æ®µ
        function previousPhase() {
            // å¦‚æœæ˜¯å®Œæˆé˜¶æ®µï¼Œä¸å…è®¸åˆ‡æ¢
            if (phases[currentPhase].isCompletion) return;
            
            if (currentPhase > 0) {
                switchToPhase(currentPhase - 1);
            } else {
                switchToPhase(phases.length - 1);
            }
        }

        // åˆ‡æ¢åˆ°ä¸‹ä¸€é˜¶æ®µ
        function nextPhase() {
            // å¦‚æœæ˜¯å®Œæˆé˜¶æ®µï¼Œä¸å…è®¸åˆ‡æ¢
            if (phases[currentPhase].isCompletion) return;
            
            if (currentPhase < phases.length - 1) {
                switchToPhase(currentPhase + 1);
            } else {
                switchToPhase(0);
            }
        }

        // å¼€å§‹å‡†å¤‡å€’è®¡æ—¶
        function startCountdown() {
            let count = 3;
            countdownNumber.textContent = count;
            countdownOverlay.classList.add('active');
            
            // ç«‹å³æ’­æ”¾ç¬¬ä¸€æ¬¡å€’è®¡æ—¶å£°éŸ³
            playWarningSound();
            
            const countdownInterval = setInterval(() => {
                count--;
                if (count > 0) {
                    countdownNumber.textContent = count;
                    playWarningSound(); // æ’­æ”¾è­¦å‘Šå£°ä½œä¸ºå€’è®¡æ—¶éŸ³æ•ˆ
                } else {
                    countdownNumber.textContent = "å¼€å§‹!";
                    playWarningSound(); // æ’­æ”¾"å¼€å§‹"éŸ³æ•ˆ
                    setTimeout(() => {
                        countdownOverlay.classList.remove('active');
                        clearInterval(countdownInterval);
                        
                        // è®°å½•å¼€å§‹æ—¶é—´
                        startTimestamp = new Date();
                        const timeString = startTimestamp.toLocaleTimeString();
                        startTimeElement.textContent = `å¼€å§‹æ—¶é—´: ${timeString}`;
                        startTimeMobileElement.textContent = `å¼€å§‹æ—¶é—´: ${timeString}`;
                        
                        startTimer(); // å€’è®¡æ—¶ç»“æŸåå¼€å§‹æ­£å¼è®¡æ—¶
                    }, 1000);
                }
            }, 1000);
        }

        // è®¡æ—¶å™¨ä¸»å‡½æ•°
        function updateTimer() {
            if (!isRunning) return;
            
            totalSeconds++;
            
            if (phases[currentPhase].isCompletion) {
                // å®Œæˆé˜¶æ®µï¼šæ­£è®¡æ—¶
                phaseSeconds++;
                
                // æ’­æ”¾æ»´ç­”å£°
                playTickSound();
            } else {
                // æ­£å¸¸é˜¶æ®µï¼šå€’è®¡æ—¶
                phaseSeconds--;
                
                // æ’­æ”¾æ»´ç­”å£°
                playTickSound();
                
                // æ£€æŸ¥å¹¶æ’­æ”¾è¯­éŸ³æç¤º
                checkAndPlayTts();
                
                // æ£€æŸ¥é˜¶æ®µåˆ‡æ¢
                if (phaseSeconds <= 0) {
                    // æ’­æ”¾è­¦å‘Šå£°ä½œä¸ºé˜¶æ®µç»“æŸæç¤º
                    playWarningSound();
                    
                    // ä¿®å¤ï¼šåœ¨åˆ‡æ¢åˆ°è®­ç»ƒå®Œæˆé˜¶æ®µæ—¶è®°å½•ç»“æŸæ—¶é—´
                    if (currentPhase === phases.length - 2) { // å¦‚æœå½“å‰æ˜¯æ”¾æ¾æ‹‰ä¼¸é˜¶æ®µï¼ˆå€’æ•°ç¬¬äºŒä¸ªé˜¶æ®µï¼‰
                        endTimestamp = new Date();
                        const timeString = endTimestamp.toLocaleTimeString();
                        endTimeElement.textContent = `ç»“æŸæ—¶é—´: ${timeString}`;
                        endTimeMobileElement.textContent = `ç»“æŸæ—¶é—´: ${timeString}`;
                    }
                    
                    // åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªé˜¶æ®µ
                    currentPhase++;
                    
                    if (currentPhase >= phases.length) {
                        // æ‰€æœ‰é˜¶æ®µå®Œæˆ
                        currentPhase = phases.length - 1; // ä¿æŒåœ¨å®Œæˆé˜¶æ®µ
                        phaseSeconds = 0;
                        
                        // æ’­æ”¾åº†ç¥éŸ³æ•ˆ
                        playCelebrationSound();
                    } else {
                        // é‡ç½®é˜¶æ®µæ—¶é—´
                        phaseSeconds = phases[currentPhase].duration;
                        
                        // å¦‚æœåˆ‡æ¢åˆ°è®­ç»ƒå®Œæˆé˜¶æ®µï¼Œæ’­æ”¾åº†ç¥éŸ³æ•ˆ
                        if (phases[currentPhase].isCompletion) {
                            playCelebrationSound();
                        }
                    }
                }
                
                // æ£€æŸ¥æ˜¯å¦éœ€è¦æ’­æ”¾è­¦å‘Šå£°ï¼ˆé˜¶æ®µåˆ‡æ¢å‰3ç§’ï¼‰
                if (phaseSeconds <= 3 && phaseSeconds > 0) {
                    playWarningSound();
                }
            }
            
            // æ›´æ–°æ˜¾ç¤º
            updatePhaseDisplay();
        }

        // å¼€å§‹è®¡æ—¶å™¨
        function startTimer() {
            if (isRunning) return;
            
            isRunning = true;
            isPaused = false;
            
            startBtn.disabled = true;
            pauseBtn.disabled = false;
            resetBtn.disabled = false;
            
            updateTimerStatus();
            
            timerInterval = setInterval(updateTimer, 1000);
        }

        // æš‚åœè®¡æ—¶å™¨
        function pauseTimer() {
            if (!isRunning) return;
            
            isRunning = false;
            isPaused = true;
            
            clearInterval(timerInterval);
            
            startBtn.disabled = false;
            pauseBtn.disabled = true;
            startBtn.textContent = "ç»§ç»­";
            
            updateTimerStatus();
        }

        // åœæ­¢è®¡æ—¶å™¨
        function stopTimer() {
            isRunning = false;
            isPaused = false;
            
            clearInterval(timerInterval);
            
            startBtn.disabled = false;
            pauseBtn.disabled = true;
            resetBtn.disabled = true;
            startBtn.textContent = "å¼€å§‹";
            
            updateTimerStatus();
        }

        // é‡ç½®è®¡æ—¶å™¨
        function resetTimer() {
            stopTimer();
            
            currentPhase = 0;
            totalSeconds = 0;
            phaseSeconds = phases[0].duration;
            startTimestamp = null;
            endTimestamp = null;
            startTimeElement.textContent = "å¼€å§‹æ—¶é—´: --:--:--";
            endTimeElement.textContent = "ç»“æŸæ—¶é—´: --:--:--";
            startTimeMobileElement.textContent = "å¼€å§‹æ—¶é—´: --:--:--";
            endTimeMobileElement.textContent = "ç»“æŸæ—¶é—´: --:--:--";
            
            updatePhaseDisplay();
        }

        // æ‰“å¼€ç¼–è¾‘é˜¶æ®µæ¨¡æ€æ¡†
        function openEditPhasesModal() {
            if (isRunning) {
                alert("è®¡æ—¶å™¨è¿è¡Œæ—¶ä¸èƒ½ç¼–è¾‘é˜¶æ®µï¼Œè¯·å…ˆæš‚åœæˆ–é‡ç½®è®¡æ—¶å™¨ã€‚");
                return;
            }
            
            phasesEditContainer.innerHTML = '';
            
            phases.forEach((phase, index) => {
                const phaseEditDiv = document.createElement('div');
                phaseEditDiv.className = 'phase-edit-item';
                
                const phaseHeader = document.createElement('div');
                phaseHeader.className = 'phase-edit-header';
                
                const phaseTitle = document.createElement('div');
                phaseTitle.className = 'phase-edit-title';
                
                // æ·»åŠ é˜¶æ®µåç§°
                const phaseNameSpan = document.createElement('span');
                phaseNameSpan.textContent = `${index + 1}. ${phase.name}`;
                phaseTitle.appendChild(phaseNameSpan);
                
                // æ·»åŠ é˜¶æ®µæ—¶é—´æ˜¾ç¤ºï¼ˆè®­ç»ƒå®Œæˆé˜¶æ®µé™¤å¤–ï¼‰
                if (!phase.isCompletion) {
                    const phaseDurationSpan = document.createElement('span');
                    phaseDurationSpan.className = 'phase-duration-display';
                    phaseDurationSpan.textContent = `${Math.floor(phase.duration / 60)} åˆ†é’Ÿ`;
                    phaseTitle.appendChild(phaseDurationSpan);
                }
                
                const toggleBtn = document.createElement('button');
                toggleBtn.className = 'toggle-btn';
                toggleBtn.textContent = 'â–¼';
                toggleBtn.dataset.index = index;
                
                phaseHeader.appendChild(phaseTitle);
                phaseHeader.appendChild(toggleBtn);
                
                const phaseContent = document.createElement('div');
                phaseContent.className = 'phase-edit-content';
                phaseContent.id = `phase-content-${index}`;
                
                const nameLabel = document.createElement('label');
                nameLabel.textContent = 'é˜¶æ®µåç§°:';
                const nameInput = document.createElement('input');
                nameInput.type = 'text';
                nameInput.value = phase.name;
                nameInput.dataset.index = index;
                nameInput.dataset.field = 'name';
                
                const descLabel = document.createElement('label');
                descLabel.textContent = 'é˜¶æ®µæè¿°:';
                const descInput = document.createElement('input');
                descInput.type = 'text';
                descInput.value = phase.description;
                descInput.dataset.index = index;
                descInput.dataset.field = 'description';
                
                const durationLabel = document.createElement('label');
                durationLabel.textContent = 'æŒç»­æ—¶é—´ (åˆ†é’Ÿ):';
                const durationInput = document.createElement('input');
                durationInput.type = 'number';
                durationInput.min = '1';
                durationInput.max = '120';
                durationInput.value = Math.floor(phase.duration / 60);
                durationInput.dataset.index = index;
                durationInput.dataset.field = 'duration';
                
                // å®Œæˆé˜¶æ®µä¸æ˜¾ç¤ºåˆ é™¤æŒ‰é’®ï¼Œå¹¶ç¦ç”¨æŒç»­æ—¶é—´è¾“å…¥
                if (phase.isCompletion) {
                    durationInput.disabled = true;
                    durationInput.value = 0;
                }
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-phase-btn';
                deleteBtn.textContent = 'åˆ é™¤é˜¶æ®µ';
                deleteBtn.addEventListener('click', () => {
                    if (phases.length > 2) { // è‡³å°‘ä¿ç•™ä¸¤ä¸ªé˜¶æ®µï¼ˆä¸€ä¸ªæ™®é€šé˜¶æ®µ+å®Œæˆé˜¶æ®µï¼‰
                        phases.splice(index, 1);
                        openEditPhasesModal(); // é‡æ–°æ¸²æŸ“
                    } else {
                        alert('è‡³å°‘éœ€è¦ä¿ç•™ä¸€ä¸ªè®­ç»ƒé˜¶æ®µ');
                    }
                });
                
                phaseContent.appendChild(nameLabel);
                phaseContent.appendChild(nameInput);
                phaseContent.appendChild(descLabel);
                phaseContent.appendChild(descInput);
                phaseContent.appendChild(durationLabel);
                phaseContent.appendChild(durationInput);
                
                // å®Œæˆé˜¶æ®µä¸æ˜¾ç¤ºåˆ é™¤æŒ‰é’®
                if (!phase.isCompletion) {
                    phaseContent.appendChild(deleteBtn);
                }
                
                phaseEditDiv.appendChild(phaseHeader);
                phaseEditDiv.appendChild(phaseContent);
                phasesEditContainer.appendChild(phaseEditDiv);
                
                // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                toggleBtn.addEventListener('click', () => {
                    const content = document.getElementById(`phase-content-${index}`);
                    if (content.classList.contains('show')) {
                        content.classList.remove('show');
                        toggleBtn.textContent = 'â–¼';
                    } else {
                        content.classList.add('show');
                        toggleBtn.textContent = 'â–²';
                    }
                });
                
                // æ·»åŠ æŒç»­æ—¶é—´è¾“å…¥å˜åŒ–äº‹ä»¶ï¼Œæ›´æ–°é˜¶æ®µæ ‡é¢˜ä¸­çš„æ—¶é—´æ˜¾ç¤º
                if (!phase.isCompletion) {
                    durationInput.addEventListener('input', () => {
                        const minutes = durationInput.value;
                        const durationSpan = phaseTitle.querySelector('.phase-duration-display');
                        if (durationSpan) {
                            durationSpan.textContent = `${minutes} åˆ†é’Ÿ`;
                        }
                    });
                }
            });
            
            editPhasesModal.style.display = 'flex';
        }

        // ä¿å­˜é˜¶æ®µç¼–è¾‘
        function savePhasesEdit() {
            let hasError = false;
            
            const inputs = phasesEditContainer.querySelectorAll('input');

            // å…ˆéªŒè¯æ‰€æœ‰è¾“å…¥
            inputs.forEach(input => {
                const field = input.dataset.field;
                const index = parseInt(input.dataset.index);
                const phase = phases[index];

                // å¦‚æœæ˜¯å®Œæˆé˜¶æ®µï¼Œè·³è¿‡æŒç»­æ—¶é—´çš„éªŒè¯
                if (field === 'duration' && phase.isCompletion) {
                    return;
                }

                if (field === 'duration') {
                    const minutes = parseInt(input.value);

                    if (isNaN(minutes) || minutes < 1 || minutes > 120) {
                        hasError = true;
                        input.style.border = "2px solid #F44336";
                    } else {
                        input.style.border = "";
                    }
                }
            });
            
            // å¦‚æœæœ‰é”™è¯¯ï¼Œæç¤ºç”¨æˆ·
            if (hasError) {
                alert("è¯·è¾“å…¥1-120ä¹‹é—´çš„æœ‰æ•ˆåˆ†é’Ÿæ•°");
                return;
            }
            
            // ä¿å­˜æ•°æ®
            inputs.forEach(input => {
                const index = parseInt(input.dataset.index);
                const field = input.dataset.field;
                const phase = phases[index];
                
                // å¦‚æœæ˜¯å®Œæˆé˜¶æ®µï¼Œè·³è¿‡æŒç»­æ—¶é—´çš„ä¿®æ”¹
                if (field === 'duration' && phase.isCompletion) {
                    return;
                }
                
                if (field === 'duration') {
                    const minutes = parseInt(input.value);
                    phases[index][field] = minutes * 60;
                } else {
                    phases[index][field] = input.value;
                }
            });
            
            // é‡ç½®å½“å‰é˜¶æ®µå’Œè®¡æ—¶å™¨
            currentPhase = 0;
            phaseSeconds = phases[0].duration;
            totalSeconds = 0;
            
            // æ›´æ–°æ˜¾ç¤º
            initializePhaseCarousel();
            updatePhaseDisplay();

            editPhasesModal.style.display = 'none';

        }

        // æ·»åŠ æ–°é˜¶æ®µ
        function addNewPhase() {
            // åœ¨å®Œæˆé˜¶æ®µä¹‹å‰æ’å…¥æ–°é˜¶æ®µ
            phases.splice(phases.length - 1, 0, {
                name: "æ–°é˜¶æ®µ",
                duration: 5 * 60,
                description: "é˜¶æ®µæè¿°"
            });
            openEditPhasesModal(); // é‡æ–°æ¸²æŸ“
        }

        // åˆå§‹åŒ–è¯­éŸ³è®¾ç½®
        function initializeTtsSettings() {
            // è·å–å¯ç”¨çš„è¯­éŸ³
            function loadVoices() {
                if ('speechSynthesis' in window) {
                    const voices = speechSynthesis.getVoices();
                    
                    // æ¸…ç©ºç°æœ‰é€‰é¡¹
                    ttsVoice.innerHTML = '<option value="">é»˜è®¤éŸ³è‰²</option>';
                    
                    // æ·»åŠ è¯­éŸ³é€‰é¡¹
                    voices.forEach(voice => {
                        const option = document.createElement('option');
                        option.value = voice.name;
                        option.textContent = `${voice.name} (${voice.lang})`;
                        ttsVoice.appendChild(option);
                    });
                    
                    // è®¾ç½®è¯­éŸ³é€‰æ‹©äº‹ä»¶
                    ttsVoice.addEventListener('change', () => {
                        const voices = speechSynthesis.getVoices();
                        const selectedVoice = voices.find(voice => voice.name === ttsVoice.value);
                        ttsVoiceSettings.voice = selectedVoice || null;
                    });
                }
            }
            
            // è¯­éŸ³åˆ—è¡¨å¯èƒ½éœ€è¦æ—¶é—´åŠ è½½
            if (speechSynthesis.getVoices().length === 0) {
                speechSynthesis.addEventListener('voiceschanged', loadVoices);
            } else {
                loadVoices();
            }
            
            // è®¾ç½®éŸ³è°ƒæ»‘å—äº‹ä»¶
            ttsPitch.addEventListener('input', () => {
                ttsPitchValue.textContent = ttsPitch.value;
                ttsVoiceSettings.pitch = parseFloat(ttsPitch.value);
            });
            
            // è®¾ç½®è¯­é€Ÿæ»‘å—äº‹ä»¶
            ttsRate.addEventListener('input', () => {
                ttsRateValue.textContent = ttsRate.value;
                ttsVoiceSettings.rate = parseFloat(ttsRate.value);
            });
            
            // è®¾ç½®æµ‹è¯•æŒ‰é’®äº‹ä»¶
            ttsTestBtn.addEventListener('click', () => {
                speakText("è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•è¯­éŸ³ï¼Œç”¨äºæµ‹è¯•å½“å‰éŸ³è‰²ã€éŸ³è°ƒå’Œè¯­é€Ÿè®¾ç½®");
            });
            
            // è®¾ç½®è¯­éŸ³è®¾ç½®åˆ‡æ¢æŒ‰é’®äº‹ä»¶
            toggleVoiceSettingsBtn.addEventListener('click', () => {
                if (ttsVoiceControls.classList.contains('show')) {
                    ttsVoiceControls.classList.remove('show');
                    toggleVoiceSettingsBtn.textContent = 'æ˜¾ç¤ºè¯­éŸ³è®¾ç½®';
                } else {
                    ttsVoiceControls.classList.add('show');
                    toggleVoiceSettingsBtn.textContent = 'éšè—è¯­éŸ³è®¾ç½®';
                }
            });
        }

        // æ‰“å¼€è¯­éŸ³è®¾ç½®æ¨¡æ€æ¡†
        function openTtsSettingsModal() {
            ttsTableBody.innerHTML = '';
            
            ttsSettings.forEach((tts, index) => {
                const row = document.createElement('tr');
                
                // é˜¶æ®µé€‰æ‹©
                const phaseCell = document.createElement('td');
                const phaseSelect = document.createElement('select');
                phases.forEach((phase, phaseIndex) => {
                    // å®Œæˆé˜¶æ®µä¸æ˜¾ç¤ºåœ¨è¯­éŸ³è®¾ç½®ä¸­
                    if (!phase.isCompletion) {
                        const option = document.createElement('option');
                        option.value = phaseIndex;
                        option.textContent = phase.name;
                        if (phaseIndex === tts.phaseId) {
                            option.selected = true;
                        }
                        phaseSelect.appendChild(option);
                    }
                });
                phaseSelect.dataset.index = index;
                phaseSelect.dataset.field = 'phaseId';
                phaseCell.appendChild(phaseSelect);
                
                // æ—¶é—´ç‚¹è¾“å…¥
                const timeCell = document.createElement('td');
                const timeInput = document.createElement('input');
                timeInput.type = 'number';
                timeInput.min = '1';
                timeInput.max = '3600';
                timeInput.value = tts.timePoint;
                timeInput.dataset.index = index;
                timeInput.dataset.field = 'timePoint';
                timeCell.appendChild(timeInput);
                
                // æ–‡æœ¬å†…å®¹è¾“å…¥
                const textCell = document.createElement('td');
                const textInput = document.createElement('input');
                textInput.type = 'text';
                textInput.value = tts.text;
                textInput.dataset.index = index;
                textInput.dataset.field = 'text';
                textCell.appendChild(textInput);
                
                // æ“ä½œæŒ‰é’®
                const actionCell = document.createElement('td');
                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'åˆ é™¤';
                deleteBtn.style.backgroundColor = '#F44336';
                deleteBtn.addEventListener('click', () => {
                    ttsSettings.splice(index, 1);
                    openTtsSettingsModal(); // é‡æ–°æ¸²æŸ“
                });
                actionCell.appendChild(deleteBtn);
                
                row.appendChild(phaseCell);
                row.appendChild(timeCell);
                row.appendChild(textCell);
                row.appendChild(actionCell);
                
                ttsTableBody.appendChild(row);
            });
            
            ttsSettingsModal.style.display = 'flex';
        }

        // ä¿å­˜è¯­éŸ³è®¾ç½®
        function saveTtsSettings() {
            const inputs = ttsTableBody.querySelectorAll('select, input');
            const newTtsSettings = [];
            
            inputs.forEach(input => {
                const index = parseInt(input.dataset.index);
                const field = input.dataset.field;
                
                if (!newTtsSettings[index]) {
                    newTtsSettings[index] = { phaseId: 0, timePoint: 0, text: '' };
                }
                
                if (field === 'phaseId' || field === 'timePoint') {
                    newTtsSettings[index][field] = parseInt(input.value);
                } else {
                    newTtsSettings[index][field] = input.value;
                }
            });
            
            ttsSettings = newTtsSettings;
            ttsSettingsModal.style.display = 'none';
        }

        // æ·»åŠ æ–°çš„è¯­éŸ³æç¤º
        function addNewTts() {
            ttsSettings.push({
                phaseId: 0,
                timePoint: 30,
                text: "æ–°çš„è¯­éŸ³æç¤º"
            });
            openTtsSettingsModal(); // é‡æ–°æ¸²æŸ“
        }

        // åˆå§‹åŒ–
        function initialize() {
            initializePhaseCarousel();
            updateCurrentTime();
            updatePhaseDisplay();
            updateTimerStatus();
            
            // åˆå§‹åŒ–éŸ³é¢‘ç³»ç»Ÿ
            initializeAudio();
            
            // åˆå§‹åŒ–è¯­éŸ³è®¾ç½®
            initializeTtsSettings();
            
            // æ¯ç§’æ›´æ–°å½“å‰æ—¶é—´
            currentTimeInterval = setInterval(updateCurrentTime, 1000);
            
            // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
            startBtn.addEventListener('click', () => {
                // ç‚¹å‡»å¼€å§‹æŒ‰é’®æ—¶åˆå§‹åŒ–éŸ³é¢‘å¹¶å¼€å§‹å€’è®¡æ—¶
                initializeAudio();
                startCountdown();
            });
            pauseBtn.addEventListener('click', pauseTimer);
            resetBtn.addEventListener('click', resetTimer);
            
            // è½®ç›˜å¯¼èˆªäº‹ä»¶
            carouselPrev.addEventListener('click', previousPhase);
            carouselNext.addEventListener('click', nextPhase);
            carouselPrevVertical.addEventListener('click', previousPhase);
            carouselNextVertical.addEventListener('click', nextPhase);
            
            // è®¾ç½®æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨
            editPhasesBtn.addEventListener('click', openEditPhasesModal);
            ttsSettingsBtn.addEventListener('click', openTtsSettingsModal);
            
            // é˜¶æ®µç¼–è¾‘æ¨¡æ€æ¡†äº‹ä»¶ç›‘å¬å™¨
            addPhaseBtn.addEventListener('click', addNewPhase);
            savePhasesBtn.addEventListener('click', savePhasesEdit);
            cancelPhasesEditBtn.addEventListener('click', () => {
                editPhasesModal.style.display = 'none';
            });
            
            // è¯­éŸ³è®¾ç½®æ¨¡æ€æ¡†äº‹ä»¶ç›‘å¬å™¨
            addTtsBtn.addEventListener('click', addNewTts);
            saveTtsBtn.addEventListener('click', saveTtsSettings);
            cancelTtsBtn.addEventListener('click', () => {
                ttsSettingsModal.style.display = 'none';
            });
            
            // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
            editPhasesModal.addEventListener('click', (e) => {
                if (e.target === editPhasesModal) {
                    editPhasesModal.style.display = 'none';
                }
            });
            
            ttsSettingsModal.addEventListener('click', (e) => {
                if (e.target === ttsSettingsModal) {
                    ttsSettingsModal.style.display = 'none';
                }
            });
            
            // çª—å£å¤§å°æ”¹å˜æ—¶æ›´æ–°è½®ç›˜ä½ç½®å’ŒæŒ‰é’®æ˜¾ç¤º
            window.addEventListener('resize', () => {
                updateCarouselPosition();
                updateNavigationButtons();
            });
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('load', initialize);
    </script>
</body>
</html>
